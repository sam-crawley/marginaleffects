---
title: Simple benchmarks for development
output: html_document
---


```sh
git checkout "0.10.0"
R CMD INSTALL .
```

```{r}
library(marginaleffects)
```

# `slopes()`

## Many factor levels: LM and GLM

```{r}
N <- 1e3
dat <- data.frame(matrix(rnorm(N * 10), ncol = 10))
dat$c1 <- factor(sample(letters, N, replace = TRUE))
dat$c2 <- factor(sample(letters, N, replace = TRUE))
dat$bin <- sample(0:1, N, replace = TRUE)
mod_lm <- lm(X1 ~ ., dat)
mod_glm <- glm(bin ~ ., dat, family = binomial)

bench::mark(
    slopes(mod_lm),
    slopes(mod_glm),
    check = FALSE,
    iterations = 3
)[, 1:5]
```

## Many variables and arguments

```{r}
N <- 1e4
dat <- data.frame(matrix(rnorm(N * 26), ncol = 26))
mod <- lm(X1 ~ ., dat)

bench::mark(
    slopes(mod),
    check = FALSE
)[, 1:5]

bench::mark(
    # marginal effects at the mean; no standard error
    comparisons(mod, vcov = FALSE, newdata = datagrid()),
    # marginal effects at the mean
    comparisons(mod, newdata = datagrid()),
    # 1 variable; no standard error
    comparisons(mod, vcov = FALSE, variables = "X3"),
    # 1 variable
    comparisons(mod, variables = "X3"),
    # 26 variables; no standard error
    comparisons(mod, vcov = FALSE),
    # 26 variables
    # comparisons(mod),
    iterations = 1, check = FALSE
)[, 1:5]
```

## Many factor variables

```{r}
N <- 1e4
dat <- data.frame(lapply(1:10, \(i) as.factor(sample(1:4, N, replace = TRUE))))
dat <- setNames(dat, paste0("X", seq_along(dat)))
dat$y <- rnorm(nrow(dat))
mod <- lm(y ~ ., dat)

bench::mark(
    slopes(mod),
    check = FALSE,
    iterations = 1
)[, 1:5]
```

## Small

```{r}
mod <- lm(mpg ~ hp + factor(gear) + factor(cyl), mtcars)
bench::mark(
    slopes(mod),
    check = FALSE
)[, 1:5]
```

## Many observations

```{r}
dat <- read.csv("https://vincentarelbundock.github.io/Rdatasets/csv/palmerpenguins/penguins.csv")
dat$large_penguin <- ifelse(dat$body_mass_g > median(dat$body_mass_g, na.rm = TRUE), 1, 0)
tmp <- list()
for (i in 1:300) tmp[[i]] <- dat
dat2 <- data.table::rbindlist(tmp)
mod <- glm(large_penguin ~ bill_length_mm + flipper_length_mm + species,
           data = dat2, family = binomial)

bench::mark(
    slopes(mod),
    check = FALSE
)[, 1:5]
```

## GLM prediction type

```{r}
d <- data.frame(y = sample(0:1, 1e5, replace = TRUE), x1 = rnorm(1e5), x2 = rnorm(1e5))
mod <- glm(y ~ x1 * x2, family = binomial, data = d)
bench::mark(
    avg_slopes(mod, type = "link"),
    avg_slopes(mod, type = "response"),
    check = FALSE
)[, 1:5]
```

# `predictions()`

## Many factor variables

```{r}
N <- 1e4
dat <- data.frame(lapply(1:10, \(i) as.factor(sample(1:4, N, replace = TRUE))))
dat <- setNames(dat, paste0("X", seq_along(dat)))
dat$y <- rnorm(nrow(dat))
mod <- lm(y ~ ., dat)

bench::mark(
    predictions(mod),
    check = FALSE,
    iterations = 5
)[, 1:5]
```