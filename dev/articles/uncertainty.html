<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="marginaleffects">
<title>Standard Errors and Confidence Intervals • marginaleffects</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Standard Errors and Confidence Intervals">
<meta property="og:description" content="marginaleffects">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">marginaleffects</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.10.0.9014</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/marginaleffects.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vincentarelbundock/marginaleffects/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Standard Errors and Confidence Intervals</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/HEAD/vignettes/uncertainty.Rmd" class="external-link"><code>vignettes/uncertainty.Rmd</code></a></small>
      <div class="d-none name"><code>uncertainty.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="delta-method">Delta Method<a class="anchor" aria-label="anchor" href="#delta-method"></a>
</h2>
<p>All the standard errors generated by the <code><a href="../reference/slopes.html">slopes()</a></code>,
<code><a href="../reference/comparisons.html">comparisons()</a></code>, and <code><a href="../reference/hypotheses.html">hypotheses()</a></code> functions of
this package package are estimated using the delta method. Mathematical
treatments of this method can be found in most statistics textbooks <a href="https://en.wikipedia.org/wiki/Delta_method" class="external-link">and on Wikipedia.</a>
Roughly speaking, the delta method allows us to approximate the
distribution of a smooth function of an asymptotically normal
estimator.</p>
<p>Concretely, this allows us to generate standard errors around
functions of a model’s coefficient estimates. Predictions, contrasts,
marginal effects, and marginal means are functions of the coefficients,
so we can use the delta method to estimate standard errors around all of
those quantities. Since there are a lot of mathematical treatments
available elsewhere, this vignette focuses on the “implementation” in
<code>marginaleffects</code>.</p>
<p>Consider the case of the <code><a href="../reference/marginal_means.html">marginal_means()</a></code> function. When
a user calls this function, they obtain a vector of marginal means. To
estimate standard errors around this vector:</p>
<ol style="list-style-type: decimal">
<li>Take the numerical derivative of the marginal means vector with
respect to the first coefficient in the model:
<ul>
<li>Compute marginal means with the original model: <span class="math inline">\(f(\beta)\)</span>
</li>
<li>Increment the first (and only the first) coefficient held inside the
model object by a small amount, and compute marginal means again: <span class="math inline">\(f(\beta+\varepsilon)\)</span>
</li>
<li>Calculate: <span class="math inline">\(\frac{f(\beta+\varepsilon) -
f(\beta)}{\varepsilon}\)</span>
</li>
</ul>
</li>
<li>Repeat step 1 for every coefficient in the model to construct a
<span class="math inline">\(J\)</span> matrix.</li>
<li>Extract the variance-covariance matrix of the coefficient estimates:
<span class="math inline">\(V\)</span>
</li>
<li>Standard errors are the square root of the diagonal of <span class="math inline">\(JVJ'\)</span>
</li>
</ol>
<p>Scroll down this page to the Numerical Derivatives section to see a
detailed explanation, along with code for manual computation.</p>
</div>
<div class="section level2">
<h2 id="standard-errors-and-intervals-for-slopes-and-comparisons">Standard errors and intervals for <code>slopes()</code> and
<code>comparisons()</code><a class="anchor" aria-label="anchor" href="#standard-errors-and-intervals-for-slopes-and-comparisons"></a>
</h2>
<p>All standard errors for the <code><a href="../reference/slopes.html">slopes()</a></code> and
<code><a href="../reference/comparisons.html">comparisons()</a></code> functions are computed using the delta
method, as described above.</p>
</div>
<div class="section level2">
<h2 id="standard-errors-and-intervals-for-marginal_means-and-predictions">Standard errors and intervals for <code>marginal_means()</code> and
<code>predictions()</code><a class="anchor" aria-label="anchor" href="#standard-errors-and-intervals-for-marginal_means-and-predictions"></a>
</h2>
<p>The <code><a href="../reference/marginal_means.html">marginal_means()</a></code> and <code><a href="../reference/predictions.html">predictions()</a></code>
function can compute the confidence intervals in two ways. If the
following conditions hold:</p>
<ul>
<li>The user sets: <code>type = "response"</code>
</li>
<li>The model class is <code>glm</code>
</li>
<li>The <code>transform</code> argument is <code>NULL</code>
</li>
</ul>
<p>then <code><a href="../reference/marginal_means.html">marginal_means()</a></code> and <code><a href="../reference/predictions.html">predictions()</a></code>
will first compute estimates on the link scale, and then back transform
them using the inverse link function supplied by
<code>insight::link_inverse(model)</code> function.</p>
<p>In all other cases, standard errors are computed using the delta
method as described above.</p>
</div>
<div class="section level2">
<h2 id="robust-standard-errors">Robust standard errors<a class="anchor" aria-label="anchor" href="#robust-standard-errors"></a>
</h2>
<p>All the functions in the <code>marginaleffects</code> package can
compute robust standard errors on the fly for any model type supported
by <a href="https://sandwich.r-forge.r-project.org/" class="external-link">the
<code>sandwich</code> package.</a> The <code>vcov</code> argument
supports string shortcuts like <code>"HC3"</code>, a one-sided formula
to request clustered standard errors, variance-covariance matrices, or
functions which return such matrices. Here are a few examples.</p>
<p>Adjusted predictions with classical or heteroskedasticity-robust
standard errors:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;      22.6      0.777 29.1   &lt;0.001  21.1   24.1</span></span>
<span><span class="co">#&gt;      22.6      0.777 29.1   &lt;0.001  21.1   24.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, estimate, std.error, statistic, p.value, conf.low, conf.high, mpg, hp</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, vcov <span class="op">=</span> <span class="st">"HC3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;      22.6      0.863 26.2   &lt;0.001  20.9   24.3</span></span>
<span><span class="co">#&gt;      22.6      0.863 26.2   &lt;0.001  20.9   24.3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, estimate, std.error, statistic, p.value, conf.low, conf.high, mpg, hp</span></span></code></pre></div>
<p>Marginal effects with cluster-robust standard errors:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, vcov <span class="op">=</span> <span class="op">~</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;    hp  -0.0682     0.0187 -3.65   &lt;0.001 -0.105 -0.0316</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Comparing adjusted predictions with classical and robust standard
errors:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span>, vcov <span class="op">=</span> <span class="st">"HC3"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-4-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="simulation-based-inference">Simulation-based inference<a class="anchor" aria-label="anchor" href="#simulation-based-inference"></a>
</h2>
<p><code>marginaleffects</code> offers an <em>experimental</em>
<code>inferences</code> function to conduct simulation-based inference
following the strategy proposed by Krinsky &amp; Robb (1986):</p>
<ol style="list-style-type: decimal">
<li>Draw <code>iter</code> sets of simulated coefficients from a
multivariate normal distribution with mean equal to the original model’s
estimated coefficients and variance equal to the model’s
variance-covariance matrix (classical, “HC3”, or other).</li>
<li>Use the <code>iter</code> sets of coefficients to compute
<code>iter</code> sets of estimands: predictions, comparisons, or
slopes.</li>
<li>Take quantiles of the resulting distribution of estimands to obtain
a confidence interval and the standard deviation of simulated estimates
to estimate the standard error.</li>
</ol>
<p>Here are a few examples:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjskay.github.io/ggdist/" class="external-link">ggdist</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">*</span> <span class="va">wt</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/inferences.html">inferences</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simulation"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate Std. Error    2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  7.84e-01      0.195 2.52e-01  0.971</span></span>
<span><span class="co">#&gt;  7.84e-01      0.162 3.37e-01  0.956</span></span>
<span><span class="co">#&gt;  8.98e-01      0.141 4.53e-01  0.988</span></span>
<span><span class="co">#&gt;  8.74e-01      0.230 1.59e-01  0.995</span></span>
<span><span class="co">#&gt;  1.31e-02      0.189 5.80e-05  0.776</span></span>
<span><span class="co">#&gt; --- 22 rows omitted. See ?avg_predictions and ?print.marginaleffects --- </span></span>
<span><span class="co">#&gt;  3.83e-01      0.291 1.67e-02  0.956</span></span>
<span><span class="co">#&gt;  1.21e-06      0.135 1.89e-12  0.538</span></span>
<span><span class="co">#&gt;  6.89e-03      0.143 3.24e-05  0.571</span></span>
<span><span class="co">#&gt;  8.07e-11      0.165 2.22e-16  0.889</span></span>
<span><span class="co">#&gt;  7.95e-01      0.166 3.41e-01  0.962</span></span>
<span><span class="co">#&gt; Columns: rowid, estimate, std.error, conf.low, conf.high, vs, hp, wt, gear</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span>vcov <span class="op">=</span> <span class="op">~</span><span class="va">gear</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/inferences.html">inferences</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simulation"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error   2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  gear    4 - 3 -0.04019    0.05594 -0.0939 0.1245</span></span>
<span><span class="co">#&gt;  gear    5 - 3 -0.19877    0.27518 -0.4874 0.3335</span></span>
<span><span class="co">#&gt;  hp      dY/dX -0.00473    0.00451 -0.0116 0.0046</span></span>
<span><span class="co">#&gt;  wt      dY/dX  0.00696    0.32085 -0.6104 0.7065</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, contrast, estimate, std.error, conf.low, conf.high</span></span></code></pre></div>
<p>Since simulation based inference generates <code>iter</code>
estimates of the quantities of interest, we can treat them similarly to
draws from the posterior distribution in bayesian models. For example,
we can extract draws using the <code><a href="../reference/posterior_draws.html">posterior_draws()</a></code> function,
and plot their distributions using packages like<code>ggplot2</code> and
<code>ggdist</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span>variables <span class="op">=</span> <span class="st">"gear"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/inferences.html">inferences</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simulation"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/posterior_draws.html">posterior_draws</a></span><span class="op">(</span><span class="st">"rvar"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">contrast</span>, xdist <span class="op">=</span> <span class="va">rvar</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="http://mjskay.github.io/ggdist/reference/stat_slabinterval.html" class="external-link">stat_slabinterval</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-6-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="bootstrap">Bootstrap<a class="anchor" aria-label="anchor" href="#bootstrap"></a>
</h2>
<p>It is easy to use the bootstrap as an alternative strategy to compute
standard errors and confidence intervals. Several <code>R</code>
packages can help us achieve this, including the long-established
<code>boot</code> package:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bootfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">indices</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span>    <span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">d</span>, vcov <span class="op">=</span> <span class="cn">FALSE</span>, variables <span class="op">=</span> <span class="st">"am"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mtcars</span>, statistic <span class="op">=</span> <span class="va">bootfun</span>, R <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">b</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; boot(data = mtcars, statistic = bootfun, R = 1000)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Bootstrap Statistics :</span></span>
<span><span class="co">#&gt;     original     bias    std. error</span></span>
<span><span class="co">#&gt; t1* 4.157856 0.01543426    1.003461</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">b</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 1000 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = b, type = "perc")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level     Percentile     </span></span>
<span><span class="co">#&gt; 95%   ( 2.240,  6.277 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
<p>Note that, in the code above, we set <code>vcov=FALSE</code> to avoid
computation of delta method standard errors and speed things up.</p>
<p>Compare to the delta method standard errors:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="va">hp</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"am"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    am    1 - 0     4.16       1.26 3.31   &lt;0.001   1.7   6.62</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mixed-effects-models-satterthwaite-and-kenward-roger-corrections">Mixed effects models: Satterthwaite and Kenward-Roger
corrections<a class="anchor" aria-label="anchor" href="#mixed-effects-models-satterthwaite-and-kenward-roger-corrections"></a>
</h2>
<p>For linear mixed effects models we can apply the Satterthwaite and
Kenward-Roger corrections in the same way as above:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">cyl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">am</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">am</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">+</span> <span class="va">am</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span></code></pre></div>
<p>Marginal effects at the mean with classical standard errors and
z-statistic:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term     Contrast Estimate Std. Error     z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;    hp dY/dX         -0.0518     0.0115 -4.52   &lt;0.001 -0.0743 -0.0294</span></span>
<span><span class="co">#&gt;    am TRUE - FALSE   4.6661     1.1343  4.11   &lt;0.001  2.4430  6.8892</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, mpg, hp, am, cyl</span></span></code></pre></div>
<p>Marginal effects at the mean with Kenward-Roger adjusted
variance-covariance and degrees of freedom:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>                newdata <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"kenward-roger"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term     Contrast Estimate Std. Error     t Pr(&gt;|t|)  2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;    hp dY/dX         -0.0518     0.0152 -3.41   0.0964 -0.131  0.0269</span></span>
<span><span class="co">#&gt;    am TRUE - FALSE   4.6661     1.2824  3.64   0.0874 -1.980 11.3121</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, df, predicted, predicted_hi, predicted_lo, mpg, hp, am, cyl</span></span></code></pre></div>
<p>We can use the same option in any of the package’s core functions,
including:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span><span class="va">mod</span>, condition <span class="op">=</span> <span class="st">"hp"</span>, vcov <span class="op">=</span> <span class="st">"satterthwaite"</span><span class="op">)</span></span></code></pre></div>
<p><img src="uncertainty_files/figure-html/unnamed-chunk-12-1.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="numerical-derivatives-sensitivity-to-step-size">Numerical derivatives: Sensitivity to step size<a class="anchor" aria-label="anchor" href="#numerical-derivatives-sensitivity-to-step-size"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/palmerpenguins/penguins.csv"</span><span class="op">)</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">large_penguin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">body_mass_g</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">large_penguin</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">flipper_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p><code>marginaleffects</code> uses numerical derivatives in two
contexts:</p>
<ol style="list-style-type: decimal">
<li>Estimate the partial derivatives reported by <code><a href="../reference/slopes.html">slopes()</a></code>
function.
<ul>
<li>Centered finite difference</li>
<li>
<span class="math inline">\(\frac{f(x + \varepsilon_1 / 2) - f(x -
\varepsilon_1 / 2)}{\varepsilon_1}\)</span>, where we take the
derivative with respect to a predictor of interest, and <span class="math inline">\(f\)</span> is the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>
function.</li>
</ul>
</li>
<li>Estimate standard errors using the delta method.
<ul>
<li>Forward finite difference</li>
<li>
<span class="math inline">\(\frac{g(\hat{\beta}) - g(\hat{\beta} +
\varepsilon_2)}{\varepsilon_2}\)</span>, where we take the derivative
with respect to a model’s coefficients, and <span class="math inline">\(g\)</span> is a <code>marginaleffects</code>
function which returns some quantity of interest (e.g., slope, marginal
means, predictions, etc.)</li>
</ul>
</li>
</ol>
<p>Note that the step sizes used in those two contexts can differ. If
the variables and coefficients have very different scales, it may make
sense to use different values for <span class="math inline">\(\varepsilon_1\)</span> and <span class="math inline">\(\varepsilon_2\)</span>.</p>
<p>By default, <span class="math inline">\(\varepsilon_1\)</span> is set
to <code>1e-4</code> times the range of the variable with respect to
which we are taking the derivative. By default, <span class="math inline">\(\varepsilon_2\)</span> is set to the maximum value
of <code>1e-8</code>, or <code>1e-4</code> times the smallest absolute
coefficient estimate. (These choices are arbitrary, but I have found
that in practice, smaller values can produce unstable results.)</p>
<p><span class="math inline">\(\varepsilon_1\)</span> can be controlled
by the <code>eps</code> argument of the <code><a href="../reference/slopes.html">slopes()</a></code> function.
<span class="math inline">\(\varepsilon_2\)</span> can be controlled by
setting a global option which tells <code>marginaleffects</code> to
compute the jacobian using the <code>numDeriv</code> package instead of
its own internal functions. This allows more control over the step size,
and also gives access to other differentiation methods, such as
Richardson’s. To use <code>numDeriv</code>, we define a list of
arguments which will be pushed forward to
<code><a href="https://rdrr.io/pkg/numDeriv/man/jacobian.html" class="external-link">numDeriv::jacobian</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  bill_length_mm   0.0279    0.00595 4.68   &lt;0.001 0.0162 0.0395</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>marginaleffects_numDeriv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"Richardson"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  bill_length_mm   0.0279    0.00595 4.68   &lt;0.001 0.0162 0.0395</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>marginaleffects_numDeriv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simple"</span>, method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eps <span class="op">=</span> <span class="fl">1e-3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term Estimate Std. Error     z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  bill_length_mm   0.0279      0.568 0.049    0.961 -1.09   1.14</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>marginaleffects_numDeriv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simple"</span>, method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eps <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  bill_length_mm   0.0279    0.00601 4.64   &lt;0.001 0.0161 0.0396</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>marginaleffects_numDeriv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"simple"</span>, method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eps <span class="op">=</span> <span class="fl">1e-7</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/slopes.html">avg_slopes</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term Estimate Std. Error    z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  bill_length_mm   0.0279    0.00595 4.68   &lt;0.001 0.0162 0.0395</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Notice that the standard errors can vary considerably when using
different step sizes. It is good practice for analysts to consider the
sensitivity of their results to this setting.</p>
<p>Now, we illustrate the full process of standard error computation,
using raw <code>R</code> code. First, we choose two step sizes:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eps1</span> <span class="op">&lt;-</span> <span class="fl">1e-5</span> <span class="co"># slope</span></span>
<span><span class="va">eps2</span> <span class="op">&lt;-</span> <span class="fl">1e-7</span> <span class="co"># delta method</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">3</span><span class="op">)</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span>, eps <span class="op">=</span> <span class="va">eps1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term  Estimate Std. Error       z</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.0179765 0.00872913 2.05937</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.0359630 0.01254757 2.86613</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.0849071 0.02128611 3.98885</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, term, estimate, std.error, statistic</span></span></code></pre></div>
<p>We can get the same estimates manually with these steps:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linkinv</span> <span class="op">&lt;-</span> <span class="va">mod</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="va">linkinv</span></span>
<span></span>
<span><span class="co"># increment the variable of interest by h</span></span>
<span><span class="va">dat_hi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html" class="external-link">transform</a></span><span class="op">(</span><span class="va">dat</span>, bill_length_mm <span class="op">=</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">eps1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># model matrices: first 3 rows</span></span>
<span><span class="va">mm_lo</span> <span class="op">&lt;-</span> <span class="fu">insight</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/insight/reference/get_modelmatrix.html" class="external-link">get_modelmatrix</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span></span>
<span><span class="va">mm_hi</span> <span class="op">&lt;-</span> <span class="fu">insight</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/insight/reference/get_modelmatrix.html" class="external-link">get_modelmatrix</a></span><span class="op">(</span><span class="va">mod</span>, data <span class="op">=</span> <span class="va">dat_hi</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># predictions</span></span>
<span><span class="va">p_lo</span> <span class="op">&lt;-</span> <span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_lo</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_hi</span> <span class="op">&lt;-</span> <span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_hi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># slopes</span></span>
<span><span class="op">(</span><span class="va">p_hi</span> <span class="op">-</span> <span class="va">p_lo</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps1</span></span>
<span><span class="co">#&gt;         [,1]</span></span>
<span><span class="co">#&gt; 1 0.01797653</span></span>
<span><span class="co">#&gt; 2 0.03596304</span></span>
<span><span class="co">#&gt; 3 0.08490712</span></span></code></pre></div>
<p>To get standard errors, we build a jacobian matrix where each column
holds derivatives of the vector valued slope function, with respect to
each of the coefficients. Using the same example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b_lo</span> <span class="op">&lt;-</span> <span class="va">b_hi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="va">b_hi</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">b_hi</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">eps2</span></span>
<span></span>
<span><span class="va">dydx_lo</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_hi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b_lo</span><span class="op">)</span> <span class="op">-</span> <span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_lo</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b_lo</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps1</span></span>
<span><span class="va">dydx_hi</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_hi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b_hi</span><span class="op">)</span> <span class="op">-</span> <span class="fu">linkinv</span><span class="op">(</span><span class="va">mm_lo</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b_hi</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps1</span></span>
<span><span class="op">(</span><span class="va">dydx_hi</span> <span class="op">-</span> <span class="va">dydx_lo</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps2</span></span>
<span><span class="co">#&gt;         [,1]</span></span>
<span><span class="co">#&gt; 1 0.01600803</span></span>
<span><span class="co">#&gt; 2 0.02768619</span></span>
<span><span class="co">#&gt; 3 0.02275957</span></span></code></pre></div>
<p>This gives us the first column of <span class="math inline">\(J\)</span>, which we can recover in full from the
<code>marginaleffects</code> object attribute:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">J</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">s</span>, <span class="st">"jacobian"</span><span class="op">)</span></span>
<span><span class="va">J</span></span>
<span><span class="co">#&gt;      (Intercept) bill_length_mm flipper_length_mm speciesChinstrap speciesGentoo bill_length_mm:flipper_length_mm</span></span>
<span><span class="co">#&gt; [1,]  0.01600803      0.6777495          2.897252                0             0                         122.6916</span></span>
<span><span class="co">#&gt; [2,]  0.02768619      1.1961404          5.153100                0             0                         222.4993</span></span>
<span><span class="co">#&gt; [3,]  0.02275957      1.1492474          4.439948                0             0                         224.0825</span></span></code></pre></div>
<p>To build the full matrix, we would simply iterate through the
coefficients, incrementing them one after the other. Finally, we get
standard errors via:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">J</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">J</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.008729126 0.012547575 0.021286107</span></span></code></pre></div>
<p>Which corresponds to our original standard errors:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">s</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            Term   Estimate  Std. Error        z</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.01797653 0.008729126 2.059374</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.03596304 0.012547575 2.866135</span></span>
<span><span class="co">#&gt;  bill_length_mm 0.08490712 0.021286107 3.988851</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Columns: rowid, term, estimate, std.error, statistic</span></span></code></pre></div>
<p>Reverting to default settings:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>marginaleffects_numDeriv <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>Note that our default results for this model are very similar – but
not exactly identical – to those generated by the <code>margins</code>.
As should be expected, the results in <code>margins</code> are also very
sensitive to the value of <code>eps</code> for this model:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/leeper/margins" class="external-link">margins</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">3</span><span class="op">)</span>, unit_ses <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">SE_dydx_bill_length_mm</span></span>
<span><span class="co">#&gt; [1] 0.008728009 0.012567102 0.021293271</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">3</span><span class="op">)</span>, eps <span class="op">=</span> <span class="fl">1e-4</span>, unit_ses <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">SE_dydx_bill_length_mm</span></span>
<span><span class="co">#&gt; [1] 0.2269512 0.2255849 0.6636208</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/margins/man/margins.html" class="external-link">margins</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"bill_length_mm"</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">3</span><span class="op">)</span>, eps <span class="op">=</span> <span class="fl">1e-5</span>, unit_ses <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">$</span><span class="va">SE_dydx_bill_length_mm</span></span>
<span><span class="co">#&gt; [1] 0.02317078 0.02928266 0.05480282</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="bayesian-estimates-and-credible-intervals">Bayesian estimates and credible intervals<a class="anchor" aria-label="anchor" href="#bayesian-estimates-and-credible-intervals"></a>
</h2>
<p><a href="https://vincentarelbundock.github.io/marginaleffects/reference/brms.html">See
the <code>brms</code> vignette</a> for a discussion of bayesian
estimates and credible intervals.</p>
<!--
# Uncertainty around unit-level or average estimates

Note that it is normal to observe that confidence intervals around average estimates tend to be tighter than those around unit-level estimates:


```r
library(marginaleffects)
mod <- lm(mpg ~ hp * qsec, mtcars)

# On average CIs around unit-level estimates are:
pre1 <- predictions(mod)
as.numeric(mean(pre1$conf.high - pre1$conf.low))
#> [1] 3.835647

# The CI of the average estimate is:
pre2 <- tidy(predictions(mod))
as.numeric(pre2$conf.high - pre2$conf.low)
#> [1] 2.035368

# On average CIs around unit-level estimates are:
cmp1 <- comparisons(mod, variables = "hp")
mean(cmp1$conf.high - cmp1$conf.low)
#> [1] 0.05572727

# The CI of the average estimate is:
cmp2 <- comparisons(mod, variables = "hp", comparison = "differenceavg")
cmp2$conf.high - cmp2$conf.low
#> [1] 0.0492053
```

Relevant?
https://en.wikipedia.org/wiki/Jensen%27s_inequality
https://math.stackexchange.com/questions/34009/is-the-variance-of-a-convex-function-a-convex-function/34021#34021?newreg=698ab30a481945878307935ac5d6b629


NO LONGER RELEVANT WITH THE AVERAGE() + RECALL() REFACTOR SINCE WE COMPUTE SEs DIRECTLY ON THE MARGINS W

## Standard Error of the Average Marginal Effect or Contrast

The `avg_*()` functions computes the average marginal effect (or contrast) when they are applied to an object produced by `slopes()` (or `comparisons()`). This is done in 3 steps:

1. Extract the Jacobian used to compute unit-level standard errors.
2. Take the average of that Jacobian.
3. Estimate the standard error of the average marginal effect as the square root of the diagonal of J'VJ, where V is the variance-covariance matrix.

As [explained succinctly on Stack Exchange:](https://stats.stackexchange.com/a/331311/4874)

> we want the variance of the Average Marginal Effect (AME) and hence our transformed function is: $AME =  \frac{1}{N} \sum_{i=1}^N g_i(x_i,\hat{\beta})$ Then using the delta method we have $Var \left( g(\hat{\beta}) \right) = J_g' \Omega_{\hat{\beta}} J_g$ where $\Omega_{\hat{\beta}} = Var(\hat{\beta})$ and $J_g' = \frac{\partial\left[\frac{1}{N}\sum_{i=1}^N g (x_i,\hat{\beta})\right]}{\partial \hat\beta} = \frac{1}{N}{\left[\sum_{i=1}^N \frac{\partial \left (g (x_i,\hat{\beta})\right)}{\partial \hat\beta}\right]}$ Which justifies using the "average Jacobian" in the delta method to calculate variance of the AME.

References:

* Dowd, Bryan E, William H Greene, and Edward C Norton. “Computation of Standard Errors.” Health Services Research 49, no. 2 (April 2014): 731–50. https://doi.org/10.1111/1475-6773.12122.
* https://stats.stackexchange.com/questions/283831/delta-method-for-marginal-effects-of-generalized-linear-model?rq=1
-->
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
